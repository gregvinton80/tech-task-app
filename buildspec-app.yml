version: 0.2

# Pipeline 2: Build, Scan, and Deploy Application
# This buildspec builds the Docker image, scans it, pushes to ECR, and deploys to EKS

phases:
  install:
    runtime-versions:
      golang: 1.25
    commands:
      - echo "Installing security scanning tools..."
      
      # Install Trivy for container scanning
      - wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | apt-key add -
      - echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | tee -a /etc/apt/sources.list.d/trivy.list
      - apt-get update
      - apt-get install -y trivy
      
      # Install kubectl
      - echo "Installing kubectl..."
      - KUBECTL_VERSION=$(curl -L -s https://dl.k8s.io/release/stable.txt)
      - curl -LO "https://dl.k8s.io/release/${KUBECTL_VERSION}/bin/linux/amd64/kubectl"
      - chmod +x kubectl
      - mv kubectl /usr/local/bin/
      
      # Install AWS CLI v2
      - curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
      - unzip awscliv2.zip
      - ./aws/install --update
      
      # Install gosec for Go SAST
      - echo "Installing gosec for Go security scanning..."
      - go install github.com/securego/gosec/v2/cmd/gosec@latest
      - export PATH=$PATH:$(go env GOPATH)/bin
      
      # Install govulncheck for dependency vulnerability scanning
      - echo "Installing govulncheck for dependency scanning..."
      - go install golang.org/x/vuln/cmd/govulncheck@latest

  pre_build:
    commands:
      - echo "Logging in to Amazon ECR..."
      - aws ecr get-login-password --region $AWS_DEFAULT_REGION | docker login --username AWS --password-stdin $AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com
      
      - echo "Setting environment variables..."
      - REPOSITORY_URI=$AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/$IMAGE_REPO_NAME
      - COMMIT_HASH=$(echo $CODEBUILD_RESOLVED_SOURCE_VERSION | cut -c 1-7)
      - IMAGE_TAG=${COMMIT_HASH:=latest}
      
      - echo "Downloading Go dependencies..."
      - go mod download
      
      - echo "Running Go SAST with gosec..."
      - export PATH=$PATH:$(go env GOPATH)/bin
      - gosec -fmt json -out gosec-report.json ./... || true
      - echo "Checking for high severity security issues..."
      - gosec -severity high -confidence medium ./... || true
      
      - echo "Running dependency vulnerability scan with govulncheck..."
      - govulncheck ./... || true

  build:
    commands:
      - echo "Building Docker image..."
      - docker build -t $REPOSITORY_URI:latest .
      - docker tag $REPOSITORY_URI:latest $REPOSITORY_URI:$IMAGE_TAG
      
      - echo "Scanning Docker image with Trivy..."
      - trivy image --severity HIGH,CRITICAL --exit-code 0 $REPOSITORY_URI:latest
      
      - echo "Scanning for secrets in image..."
      - trivy image --scanners secret --exit-code 0 $REPOSITORY_URI:latest
      
      - echo "Scanning Kubernetes manifests with Trivy..."
      - trivy config --severity HIGH,CRITICAL --exit-code 0 k8s/
      
      - echo "Security scans complete. Pushing image to ECR..."
      - docker push $REPOSITORY_URI:latest
      - docker push $REPOSITORY_URI:$IMAGE_TAG
      
      - echo "Creating image definitions file..."
      - printf '[{"name":"wiz-app","imageUri":"%s"}]' $REPOSITORY_URI:$IMAGE_TAG > imagedefinitions.json
      - cat imagedefinitions.json
      
      - echo "Image pushed. ECR will perform additional scanning..."

  post_build:
    commands:
      - echo "Configuring kubectl..."
      - aws eks update-kubeconfig --region $AWS_DEFAULT_REGION --name $EKS_CLUSTER_NAME
      
      - echo "Getting MongoDB private IP from EC2..."
      - export TAG_FILTER="Name=tag:Name,Values=wiz-exercise-mongodb"
      - export STATE_FILTER="Name=instance-state-name,Values=running"
      - MONGODB_IP=$(aws ec2 describe-instances --filters "$TAG_FILTER" "$STATE_FILTER" --query "Reservations[0].Instances[0].PrivateIpAddress" --output text)
      - echo "MongoDB IP is $MONGODB_IP"
      
      - echo "Updating Kubernetes manifests..."
      - sed -i "s|ACCOUNT_ID|$AWS_ACCOUNT_ID|g" k8s/deployment.yaml
      - sed -i "s|REGION|$AWS_DEFAULT_REGION|g" k8s/deployment.yaml
      - sed -i "s|MONGODB_IP|$MONGODB_IP|g" k8s/configmap.yaml
      
      - echo "Deploying to Kubernetes..."
      - kubectl apply -f k8s/namespace.yaml
      - kubectl apply -f k8s/serviceaccount.yaml
      - kubectl apply -f k8s/configmap.yaml
      - kubectl apply -f k8s/deployment.yaml
      - kubectl apply -f k8s/service.yaml
      - kubectl apply -f k8s/ingress.yaml
      
      - echo "Waiting for deployment to complete..."
      - kubectl rollout status deployment/wiz-app -n wiz-app --timeout=5m
      
      - echo "Getting application URL..."
      - kubectl get ingress wiz-app-ingress -n wiz-app
      
      - echo "Deployment complete!"
      - echo "Application URL will be available at the ALB endpoint above"

artifacts:
  files:
    - k8s/**/*
    - imagedefinitions.json

cache:
  paths:
    - '/go/pkg/mod/**/*'
    - '/root/.cache/trivy/**/*'
